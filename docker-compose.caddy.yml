# Docker Compose with Caddy for automatic HTTPS
# Usage: HOSTNAME=your-host.ts.net docker-compose -f docker-compose.caddy.yml up -d

services:
  backend:
    build: ./backend
    container_name: auto-claude-backend
    expose:
      - "8000"
    volumes:
      - projects-data:/projects
      - claude-data:/root/.claude
      - github-data:/root/.config/gh
      - auto-claude-data:/app/.auto-claude
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - AUTO_BUILD_MODEL=${AUTO_BUILD_MODEL:-claude-sonnet-4-20250514}
      - PYTHONUNBUFFERED=1
    networks:
      - auto-claude-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Caddy - automatic HTTPS with ACME
  caddy:
    image: caddy:2-alpine
    container_name: auto-claude-caddy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - ./frontend/dist:/srv:ro  # Pre-built frontend
      - caddy-data:/data         # Cert storage
      - caddy-config:/config     # Caddy config
    environment:
      - HOSTNAME=${HOSTNAME:-localhost}
    depends_on:
      - backend
    networks:
      - auto-claude-net
    restart: unless-stopped

  # Build frontend separately (or use pre-built)
  frontend-builder:
    build: ./frontend
    container_name: auto-claude-frontend-builder
    volumes:
      - ./frontend/dist:/output
    command: sh -c "cp -r /usr/share/nginx/html/* /output/"
    profiles:
      - build  # Only run with: docker-compose --profile build up frontend-builder

  redis:
    image: redis:7-alpine
    container_name: auto-claude-redis
    expose:
      - "6379"
    volumes:
      - redis-data:/data
    networks:
      - auto-claude-net
    restart: unless-stopped
    command: redis-server --appendonly yes

volumes:
  projects-data:
  auto-claude-data:
  redis-data:
  claude-data:
  github-data:
  caddy-data:    # Stores ACME certs
  caddy-config:

networks:
  auto-claude-net:
    driver: bridge
